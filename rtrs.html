<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simarn Staffing Portal - RTRs</title>
  <link rel="stylesheet" href="style.css?v=999" />
</head>

<body>
  <!-- TOP BLACK BAR (same as other pages) -->
  <div class="topbar">
    <div class="brand">
      <img class="logo" src="logo.png" alt="Simarn Logo" />
      <span>Simarn Staffing Portal</span>
    </div>

    <div class="nav">
      <a href="index.html">Dashboard</a>
      <a href="candidates.html">Candidates</a>
      <a class="active" href="rtrs.html">RTRs</a>
      <a href="recruiters.html">Recruiters</a>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h1>RTRs</h1>
      <h3>Mark RTR Completed</h3>

      <label class="small">Candidate</label>
      <select id="candidateSelect" style="width:100%;padding:10px;margin:6px 0 12px;"></select>

      <p class="small">Select a candidate and click Add RTR.</p>

      <label class="small">RTR Date</label>
      <input id="rtrDate" type="date" style="width:100%;padding:10px;margin:6px 0 12px;" />

      <button id="btnAddRTR">Add RTR</button>
      <p class="small" id="msg"></p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Recent RTRs</h2>

      <div style="overflow:auto;">
        <table class="simple-table">
          <thead>
            <tr>
              <th align="left">Candidate</th>
              <th align="left">Domain/Role</th>
              <th align="left">RTR Date</th>
            </tr>
          </thead>
          <tbody id="rtrRows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const msg = document.getElementById("msg");
    const candidateSelect = document.getElementById("candidateSelect");
    const rtrRows = document.getElementById("rtrRows");

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    async function loadCandidatesForDropdown(){
      const r = await apiGet("candidates");
      if(!r || r.ok === false) throw new Error(r?.error || "Failed to load candidates");

      const list = r.data || [];
      candidateSelect.innerHTML = "";

      list.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.candidate_id || "";
        opt.textContent = `${c.name || ""} (${c.domain_role || "Unknown"})`;
        opt.dataset.name = c.name || "";
        opt.dataset.role = c.domain_role || "";
        candidateSelect.appendChild(opt);
      });
    }

    async function loadRecentRTRs(){
      const r = await apiGet("rtrs");
      if(!r || r.ok === false) throw new Error(r?.error || "Failed to load RTRs");

      const list = (r.data || []).slice().reverse().slice(0, 10);

      rtrRows.innerHTML = "";
      list.forEach(x => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(x.candidate_name)}</td>
          <td>${esc(x.domain_role)}</td>
          <td>${esc(x.rtr_date)}</td>
        `;
        rtrRows.appendChild(tr);
      });
    }

    document.getElementById("btnAddRTR").addEventListener("click", async () => {
      msg.textContent = "Saving...";
      try{
        const opt = candidateSelect.options[candidateSelect.selectedIndex];
        const candidate_id = candidateSelect.value;
        const candidate_name = opt?.dataset?.name || "";
        const domain_role = opt?.dataset?.role || "";
        const rtr_date = document.getElementById("rtrDate").value;

        if(!candidate_id) throw new Error("Pick a candidate");
        if(!rtr_date) throw new Error("Pick RTR date");

        const r = await apiPost("addRTR", { candidate_id, candidate_name, domain_role, rtr_date });
        if(!r || r.ok === false) throw new Error(r?.error || "Save failed");

        msg.textContent = "RTR added âœ…";
        await loadRecentRTRs();
        setTimeout(()=>msg.textContent="", 1200);
      }catch(e){
        console.error(e);
        msg.textContent = "Error: " + e.message;
      }
    });

    (async () => {
      try{
        // default date = today
        document.getElementById("rtrDate").value = new Date().toISOString().slice(0,10);
        await loadCandidatesForDropdown();
        await loadRecentRTRs();
      }catch(e){
        console.error(e);
        msg.textContent = "Error: API failed to load";
      }
    })();
  </script>
</body>
</html>
