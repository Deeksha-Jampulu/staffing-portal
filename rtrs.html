<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTRs</title>
  <link rel="stylesheet" href="style.css?v=30" />
</head>

<body>
  <nav>
   <a href="index.html">Dashboard</a>
   <a href="candidates.html">Candidates</a>
   <a href="rtrs.html">RTRs</a>
   <a href="recruiters.html">Recruiters</a>
  </nav>


  <div class="container">
    <div class="card">
      <h1>RTRs</h1>

      <h3>Mark RTR Completed</h3>

      <label class="small">Candidate</label><br/>
      <select id="candidateSelect" style="width:100%;padding:10px;margin-top:6px;"></select>
      <p class="small" id="candHint"></p>

      <label class="small">RTR Date</label><br/>
      <input id="rtr_date" type="date" style="width:100%;padding:10px;margin-top:6px;" />

      <button id="addRtrBtn" style="margin-top:12px;">Add RTR</button>
      <p class="small" id="msg"></p>
    </div>

    <div class="card">
      <h3>Recent RTRs</h3>
      <table border="1" width="100%" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th>Candidate</th>
            <th>Domain/Role</th>
            <th>RTR Date</th>
          </tr>
        </thead>
        <tbody id="rtrRows"></tbody>
      </table>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    function esc(x){ return String(x ?? ""); }

    function setTodayDefault() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      document.getElementById("rtr_date").value = `${yyyy}-${mm}-${dd}`;
    }

    async function loadCandidatesDropdown() {
      const hint = document.getElementById("candHint");
      hint.textContent = "Loading candidates...";

      const r = await apiGet("candidates");
      if (!r || r.ok === false) {
        hint.textContent = "Error loading candidates";
        return;
      }

      const sel = document.getElementById("candidateSelect");
      sel.innerHTML = "";

      (r.data || []).forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.candidate_id || "";
        opt.textContent = `${c.name || ""} (${c.domain_role || "Unknown"})`;
        opt.dataset.name = c.name || "";
        opt.dataset.role = c.domain_role || "Unknown";
        sel.appendChild(opt);
      });

      hint.textContent = (sel.options.length > 0)
        ? "Select a candidate and click Add RTR."
        : "No candidates found. Add candidates first.";
    }

    async function loadRTRs() {
      const r = await apiGet("rtrs");
      if (!r || r.ok === false) return;

      const rows = document.getElementById("rtrRows");
      rows.innerHTML = "";

      const list = (r.data || []).slice().reverse().slice(0, 25);
      list.forEach(x => {
        rows.innerHTML += `
          <tr>
            <td>${esc(x.candidate_name)}</td>
            <td>${esc(x.domain_role)}</td>
            <td>${esc(x.rtr_date)}</td>
          </tr>
        `;
      });
    }

    async function addRTR() {
      const msg = document.getElementById("msg");
      const btn = document.getElementById("addRtrBtn");

      const sel = document.getElementById("candidateSelect");
      if (!sel.value) {
        msg.textContent = "Please select a candidate first.";
        return;
      }

      const opt = sel.options[sel.selectedIndex];
      const rtrDate = document.getElementById("rtr_date").value;

      btn.disabled = true;
      msg.textContent = "Saving...";

      const payload = {
        candidate_id: sel.value,
        candidate_name: opt.dataset.name,
        domain_role: opt.dataset.role,
        rtr_date: rtrDate
      };

      const r = await apiPost("addRTR", payload);

      if (r && r.ok) {
        msg.textContent = "Added âœ…";
        await loadRTRs();
      } else {
        msg.textContent = "Error adding RTR";
      }

      btn.disabled = false;
    }

    document.getElementById("addRtrBtn").addEventListener("click", addRTR);

    setTodayDefault();
    loadCandidatesDropdown();
    loadRTRs();
  </script>
</body>
</html>
