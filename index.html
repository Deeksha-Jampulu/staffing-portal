<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staffing Portal - Dashboard</title>
  <link rel="stylesheet" href="style.css?v=10" />
</head>

<body>
  <nav>
   <a href="index.html">Dashboard</a>
   <a href="candidates.html">Candidates</a>
   <a href="rtrs.html">RTRs</a>
   <a href="recruiters.html">Recruiters</a>
  </nav>


  <div class="container">
    <div class="card">
      <h1>Dashboard</h1>

      <p>Total Candidates: <b id="candCount">-</b></p>
      <p>Total RTRs: <b id="rtrCount">-</b></p>
      <p>Total Submissions: <b id="subCount">-</b></p>

      <p class="small" id="err"></p>
    </div>

    <div class="card">
      <h1 style="font-size:18px;">Candidates by Domain/Role</h1>
      <canvas id="roleChart" height="120"></canvas>
    </div>

    <div class="card">
      <h1 style="font-size:18px;">RTRs Completed vs Total Candidates</h1>
      <canvas id="rtrChart" height="120"></canvas>
    </div>
  </div>

  <script src="app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let roleChart, rtrChart;

    async function loadDashboard() {
      const err = document.getElementById("err");
      err.textContent = "";

      try {
        const r = await apiGet("dashboard");

        if (!r || r.ok === false) {
          err.textContent = "Error: " + (r?.error || "API failed");
          return;
        }

        // Counts
        document.getElementById("candCount").textContent = r.total_candidates ?? 0;
        document.getElementById("rtrCount").textContent = r.total_rtrs ?? 0;
        document.getElementById("subCount").textContent = r.total_submissions ?? 0;

        // -------- Bar chart: candidates by role --------
        const byRole = r.candidates_by_role || {};
        const labels = Object.keys(byRole);
        const values = labels.map(k => byRole[k]);

        const ctx1 = document.getElementById("roleChart").getContext("2d");
        if (roleChart) roleChart.destroy();
        roleChart = new Chart(ctx1, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{ label: "Candidates", data: values }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } }
          }
        });

        // -------- Donut chart: RTRs vs remaining --------
        const total = r.total_candidates ?? 0;
        const rtrs = r.total_rtrs ?? 0;

        const ctx2 = document.getElementById("rtrChart").getContext("2d");
        if (rtrChart) rtrChart.destroy();
        rtrChart = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: ["RTRs Completed", "Remaining"],
            datasets: [{ data: [rtrs, Math.max(total - rtrs, 0)] }]
          },
          options: { responsive: true }
        });

      } catch (e) {
        console.error(e);
        err.textContent = "Error: API failed to load";
      }
    }

    loadDashboard();
  </script>
</body>
</html>

