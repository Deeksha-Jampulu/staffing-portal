<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simarn Staffing Portal</title>
  <link rel="stylesheet" href="style.css?v=50" />
</head>

<body>
  <nav>
    <div class="brand">
      <img src="logo.png" alt="Simarn Logo" />
      <span>Simarn Staffing Portal</span>
    </div>

    <a href="index.html"><b>Dashboard</b></a>
    <a href="candidates.html">Candidates</a>
    <a href="rtrs.html">RTRs</a>
    <a href="recruiters.html">Recruiters</a>
  </nav>

  <div class="container">

    <!-- TOP STATS -->
    <div class="card">
      <h1>Dashboard</h1>

      <p>Total Candidates: <b id="candCount">-</b></p>
      <p>RTRs Completed (Total): <b id="rtrCount">-</b></p>
      <p>RTRs Completed (Unique Candidates): <b id="rtrUnique">-</b></p>
      <p>RTR Completion Rate: <b id="rtrRate">-</b></p>
      <p>Total Submissions: <b id="subCount">-</b></p>

      <p class="small" id="err"></p>
    </div>

    <!-- CHARTS -->
    <div class="card">
      <h1 style="font-size:18px;">Candidates by Domain/Role</h1>
      <canvas id="candRoleChart" height="120"></canvas>
    </div>

    <div class="card">
      <h1 style="font-size:18px;">RTRs Completed vs Remaining (Unique Candidates)</h1>
      <canvas id="rtrDonut" height="120"></canvas>
    </div>

    <div class="card">
      <h1 style="font-size:18px;">RTRs by Domain/Role</h1>
      <canvas id="rtrRoleChart" height="120"></canvas>
    </div>

    <!-- RECENT ACTIVITY -->
    <div class="card">
      <h1 style="font-size:18px;">Recent RTR Activity</h1>

      <table border="1" width="100%" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th>Candidate</th>
            <th>Domain/Role</th>
            <th>RTR Date</th>
          </tr>
        </thead>
        <tbody id="recentRows"></tbody>
      </table>
    </div>

  </div>

  <script src="app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let candRoleChart, rtrRoleChart, rtrDonut;

    function esc(x){ return String(x ?? ""); }

    async function loadDashboard() {
      const err = document.getElementById("err");
      err.textContent = "";

      try {
        const r = await apiGet("dashboard");
        if (!r || r.ok === false) {
          err.textContent = "Error: " + (r?.error || "API failed");
          return;
        }

        const totalCandidates = r.total_candidates ?? 0;
        const totalRtrs = r.total_rtrs ?? 0;
        const uniqueRtrCandidates = r.linked_rtr_candidates ?? 0;
        const totalSubs = r.total_submissions ?? 0;

        document.getElementById("candCount").textContent = totalCandidates;
        document.getElementById("rtrCount").textContent = totalRtrs;
        document.getElementById("rtrUnique").textContent = uniqueRtrCandidates;
        document.getElementById("subCount").textContent = totalSubs;

        const rate = totalCandidates > 0
          ? Math.round((uniqueRtrCandidates / totalCandidates) * 100) + "%"
          : "0%";
        document.getElementById("rtrRate").textContent = rate;

        // 1) Candidates by role
        const candByRole = r.candidates_by_role || {};
        const candLabels = Object.keys(candByRole);
        const candValues = candLabels.map(k => candByRole[k]);

        const ctx1 = document.getElementById("candRoleChart").getContext("2d");
        if (candRoleChart) candRoleChart.destroy();
        candRoleChart = new Chart(ctx1, {
          type: "bar",
          data: { labels: candLabels, datasets: [{ label: "Candidates", data: candValues }] },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // 2) RTR donut using UNIQUE candidates
        const remaining = Math.max(totalCandidates - uniqueRtrCandidates, 0);
        const ctx2 = document.getElementById("rtrDonut").getContext("2d");
        if (rtrDonut) rtrDonut.destroy();
        rtrDonut = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: ["RTR Completed (Unique)", "Remaining"],
            datasets: [{ data: [uniqueRtrCandidates, remaining] }]
          },
          options: { responsive: true }
        });

        // 3) RTRs by role
        const rtrByRole = r.rtrs_by_role || {};
        const rtrLabels = Object.keys(rtrByRole);
        const rtrValues = rtrLabels.map(k => rtrByRole[k]);

        const ctx3 = document.getElementById("rtrRoleChart").getContext("2d");
        if (rtrRoleChart) rtrRoleChart.destroy();
        rtrRoleChart = new Chart(ctx3, {
          type: "bar",
          data: { labels: rtrLabels, datasets: [{ label: "RTRs", data: rtrValues }] },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Recent RTRs table
        const recent = r.recent_rtrs || [];
        const tbody = document.getElementById("recentRows");
        tbody.innerHTML = "";
        recent.forEach(x => {
          tbody.innerHTML += `
            <tr>
              <td>${esc(x.candidate_name)}</td>
              <td>${esc(x.domain_role)}</td>
              <td>${esc(x.rtr_date)}</td>
            </tr>
          `;
        });

      } catch (e) {
        console.error(e);
        err.textContent = "Error: API failed to load";
      }
    }

    loadDashboard();
  </script>
</body>
</html>
