<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simarn Staffing Portal - Dashboard</title>
  <link rel="stylesheet" href="style.css?v=1" />
</head>
<body>

  <nav class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Logo" />
      <span>Simarn Staffing Portal</span>
    </div>
    <div class="nav-links">
      <a class="active" href="index.html">Dashboard</a>
      <a href="candidates.html">Candidates</a>
      <a href="rtrs.html">RTRs</a>
      <a href="recruiters.html">Recruiters</a>
    </div>
  </nav>

  <div class="container">

    <div class="card hero">
      <div class="hero-text">
        <h1>Recruiting Snapshot</h1>
        <p class="small">Quick view of candidates + RTR progress.</p>
      </div>
      <div class="hero-img">
        <img src="team.png" alt="Team" />
      </div>
    </div>

    <div class="kpi-grid">
      <div class="card kpi">
        <div class="kpi-title">Total Candidates</div>
        <div class="kpi-value" id="kpiCandidates">0</div>
        <div class="kpi-sub">All added profiles</div>
      </div>

      <div class="card kpi">
        <div class="kpi-title">RTRs Completed</div>
        <div class="kpi-value" id="kpiRtrs">0</div>
        <div class="kpi-sub">Total RTR records</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <h2>Candidates by Role</h2>
        <div id="rolesList" class="small"></div>
      </div>

      <div class="card">
        <h2>Recent RTRs</h2>
        <div id="recentRtrs" class="small"></div>
      </div>
    </div>

    <p class="small" id="err"></p>
  </div>

  <script src="app.js"></script>
  <script>
    const err = document.getElementById("err");

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    async function loadDashboard(){
      err.textContent = "";
      try{
        const r = await apiGet("dashboard");
        if(!r || r.ok === false) throw new Error(r?.error || "Dashboard API failed");

        document.getElementById("kpiCandidates").textContent = r.total_candidates ?? 0;
        document.getElementById("kpiRtrs").textContent = r.total_rtrs ?? 0;

        const roles = r.candidates_by_role || {};
        const roleHtml = Object.keys(roles).length
          ? "<ul>" + Object.entries(roles).map(([k,v]) => `<li><b>${esc(k)}</b>: ${v}</li>`).join("") + "</ul>"
          : "<p>No data</p>";
        document.getElementById("rolesList").innerHTML = roleHtml;

        const recent = r.recent_rtrs || [];
        const recentHtml = recent.length
          ? "<ul>" + recent.map(x => `<li>${esc(x.candidate_name)} â€” ${esc(x.domain_role)} (${esc(x.rtr_date)})</li>`).join("") + "</ul>"
          : "<p>No RTRs yet</p>";
        document.getElementById("recentRtrs").innerHTML = recentHtml;

      }catch(e){
        err.textContent = "Error: " + e.message;
      }
    }

    loadDashboard();
  </script>
</body>
</html>
