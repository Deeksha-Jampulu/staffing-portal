<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simarn Staffing Portal – Candidates</title>
  <link rel="stylesheet" href="style.css?v=300" />
</head>
<body>

<!-- ✅ TOP BAR (SAME FOR ALL PAGES) -->
<div class="topbar">
  <div class="brand">
    <img src="logo.png" class="logo" alt="Simarn Logo" />
    <span>Simarn Staffing Portal</span>
  </div>

  <div class="nav">
    <a href="index.html">Dashboard</a>
    <a class="active" href="candidates.html">Candidates</a>
    <a href="rtrs.html">RTRs</a>
    <a href="recruiters.html">Recruiters</a>
  </div>
</div>

<div class="container">

  <!-- ADD CANDIDATE -->
  <div class="card">
    <h1>Candidates</h1>
    <p class="small">Add candidate and store resume as Google Drive link.</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <input id="name" placeholder="Name *" />
      <input id="email" placeholder="Email" />
      <input id="phone" placeholder="Phone (ex: +14691234567)" />
      <input id="location" placeholder="Location" />
      <input id="domain_role" placeholder="Domain / Role (QA, Oracle, Java)" style="grid-column:1 / span 2;" />
      <input id="resume_link" placeholder="Resume Link (Google Drive)" style="grid-column:1 / span 2;" />
      <textarea id="notes" placeholder="Notes about candidate"
        style="grid-column:1 / span 2;min-height:80px;"></textarea>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
      <button id="btnAdd">Add Candidate</button>
      <span class="small" id="status"></span>
    </div>
  </div>

  <!-- CANDIDATE LIST -->
  <div class="card">
    <h2>Candidate List</h2>

    <input id="search"
      placeholder="Search by name/email/role..."
      style="width:100%;margin-bottom:10px;" />

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Domain/Role</th>
            <th>Location</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Resume</th>
            <th>Notes</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="small" id="err"></p>
  </div>
</div>

<script src="app.js"></script>

<script>
const statusEl = document.getElementById("status");
const errEl = document.getElementById("err");
const tbody = document.getElementById("tbody");
let all = [];

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function render(list){
  tbody.innerHTML = "";
  list.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="nowrap">${esc(c.name)}</td>
      <td class="nowrap">${esc(c.domain_role)}</td>
      <td class="nowrap">${esc(c.location)}</td>
      <td class="emailcell">
        ${c.email ? `<a href="mailto:${esc(c.email)}">${esc(c.email)}</a>` : "-"}
      </td>
      <td class="nowrap">${esc(c.phone)}</td>
      <td class="nowrap">
        ${c.resume_link ? `<a href="${esc(c.resume_link)}" target="_blank">View</a>` : "-"}
      </td>
      <td class="notes">${esc(c.notes)}</td>
      <td class="nowrap small">
        ${c.created_at ? new Date(c.created_at).toLocaleDateString() : ""}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function load(){
  try{
    const r = await apiGet("candidates");
    if(!r || r.ok === false) throw new Error("API failed");
    all = r.data || [];
    render(all);
  }catch(e){
    errEl.textContent = "Error loading candidates";
  }
}

document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  render(all.filter(c =>
    (c.name||"").toLowerCase().includes(q) ||
    (c.email||"").toLowerCase().includes(q) ||
    (c.domain_role||"").toLowerCase().includes(q)
  ));
});

document.getElementById("btnAdd").addEventListener("click", async () => {
  statusEl.textContent = "Saving...";
  try{
    const payload = {
      name: name.value.trim(),
      email: email.value.trim(),
      phone: phone.value.trim(),
      location: location.value.trim(),
      domain_role: domain_role.value.trim(),
      resume_link: resume_link.value.trim(),
      notes: notes.value.trim()
    };

    if(!payload.name) throw new Error("Name required");

    const r = await apiPost("addCandidate", payload);
    if(!r || r.ok === false) throw new Error("Save failed");

    ["name","email","phone","location","domain_role","resume_link","notes"]
      .forEach(id => document.getElementById(id).value = "");

    statusEl.textContent = "Saved ✅";
    load();
    setTimeout(()=>statusEl.textContent="",1200);
  }catch(e){
    statusEl.textContent = "Error";
  }
});

load();
</script>

</body>
</html>
