<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staffing Portal - Candidates</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- ✅ SAME TOP BAR AS DASHBOARD -->
  <div class="topbar">
    <div class="brand">
      <!-- If your dashboard logo is different, copy that exact <img> line here -->
      <img src="logo.png" alt="Logo" class="logo" />
      <span>Simarn Staffing Portal</span>
    </div>

    <div class="nav">
      <a href="index.html">Dashboard</a>
      <a class="active" href="candidates.html">Candidates</a>
      <a href="rtr.html">RTRs</a>
      <a href="recruiters.html">Recruiters</a>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h1>Candidates</h1>
      <p class="small">Add candidate + store resume as Google Drive link.</p>

      <div class="form-grid">
        <input id="name" placeholder="Name *" />
        <input id="email" placeholder="Email" />
        <input id="phone" placeholder="Phone (+1..., etc)" />
        <input id="location" placeholder="Location" />

        <input id="domain_role" placeholder="Domain / Role (QA, Oracle, Java)" class="span-2" />
        <input id="resume_link" placeholder="Resume Link (Google Drive)" class="span-2" />
        <textarea id="notes" placeholder="Notes about candidate" class="span-2 notes-box"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
        <button id="btnAdd">Add Candidate</button>
        <span class="small" id="status"></span>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Candidate List</h2>

      <input id="search" placeholder="Search by name/email/role..." style="width:100%;margin-bottom:10px;" />

      <div class="table-wrap">
        <table id="tbl" class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Domain/Role</th>
              <th>Location</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Resume</th>
              <th>Notes</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="small" id="err"></p>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const tbody = document.getElementById("tbody");
    let all = [];

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function fmtDate(d){
      if (!d) return "";
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return esc(d);
      return dt.toLocaleDateString();
    }

    function render(list){
      tbody.innerHTML = "";
      list.forEach(c => {
        const resume = c.resume_link
          ? `<a href="${esc(c.resume_link)}" target="_blank" rel="noopener">View</a>`
          : "-";

        const email = c.email
          ? `<a href="mailto:${esc(c.email)}">${esc(c.email)}</a>`
          : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-name">${esc(c.name)}</td>
          <td class="col-role">${esc(c.domain_role || "")}</td>
          <td class="col-loc">${esc(c.location || "")}</td>
          <td class="col-email">${email}</td>
          <td class="col-phone">${esc(c.phone || "")}</td>
          <td class="col-resume">${resume}</td>
          <td class="col-notes">${esc(c.notes || "")}</td>
          <td class="col-created">${fmtDate(c.created_at)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function load(){
      errEl.textContent = "";
      try{
        const r = await apiGet("candidates");
        if(!r || r.ok === false) throw new Error(r?.error || "API failed");
        all = r.data || [];
        render(all);
      }catch(e){
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    }

    document.getElementById("search").addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase().trim();
      const filtered = all.filter(c =>
        String(c.name||"").toLowerCase().includes(q) ||
        String(c.email||"").toLowerCase().includes(q) ||
        String(c.domain_role||"").toLowerCase().includes(q)
      );
      render(filtered);
    });

    document.getElementById("btnAdd").addEventListener("click", async () => {
      statusEl.textContent = "Saving...";
      errEl.textContent = "";
      try{
        const payload = {
          name: document.getElementById("name").value.trim(),
          email: document.getElementById("email").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          location: document.getElementById("location").value.trim(),
          domain_role: document.getElementById("domain_role").value.trim(),
          resume_link: document.getElementById("resume_link").value.trim(),
          notes: document.getElementById("notes").value.trim()
        };

        if(!payload.name) throw new Error("Name is required");

        const r = await apiPost("addCandidate", payload);
        if(!r || r.ok === false) throw new Error(r?.error || "Save failed");

        ["name","email","phone","location","domain_role","resume_link","notes"]
          .forEach(id => document.getElementById(id).value = "");

        statusEl.textContent = "Saved ✅";
        await load();
        setTimeout(()=>statusEl.textContent="", 1200);
      }catch(e){
        statusEl.textContent = "";
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    });

    load();
  </script>
</body>
</html>
