<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simarn Staffing Portal - Candidates</title>
  <link rel="stylesheet" href="style.css?v=1000" />
</head>
<body>

  <nav class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Simarn Logo" />
      <span>Simarn Staffing Portal</span>
    </div>
    <div class="nav-links">
      <a href="index.html">Dashboard</a>
      <a class="active" href="candidates.html">Candidates</a>
      <a href="rtrs.html">RTRs</a>
      <a href="recruiters.html">Recruiters</a>
    </div>
  </nav>

  <div class="container">
    <div class="card">
      <h1>Candidates</h1>
      <p class="small">Add candidate and store resume as Google Drive link.</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <input id="name" placeholder="Name *" />
        <input id="email" placeholder="Email" />

        <!-- ✅ Phone accepts any format -->
        <input
          id="phone"
          type="text"
          inputmode="tel"
          placeholder="Phone (any format: 2345678902, +1 345 678 8976)"
        />

        <input id="location" placeholder="Location" />
        <input id="domain_role" placeholder="Domain / Role (QA, Oracle, Java)" style="grid-column:1 / span 2;" />
        <input id="resume_link" placeholder="Resume Link (Google Drive)" style="grid-column:1 / span 2;" />
        <textarea id="notes" placeholder="Notes about candidate" style="grid-column:1 / span 2;"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
        <button id="btnAdd">Add Candidate</button>
        <span class="small" id="status"></span>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Candidate List</h2>
      <input id="search" placeholder="Search by name/email/role..." style="width:100%;margin-bottom:10px;" />

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Domain/Role</th>
              <th>Location</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Resume</th>
              <th>Notes</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="small" id="err"></p>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const tbody = document.getElementById("tbody");
    let all = [];

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    // ✅ Accept any input, store clean
    function normalizePhone(raw){
      const original = String(raw || "").trim();
      const hasPlus = original.startsWith("+");

      let digits = original.replace(/[^\d]/g, ""); // keep digits only
      if (!digits) return "";

      // US defaults
      if (digits.length === 10) return "+1" + digits;
      if (digits.length === 11 && digits.startsWith("1")) return "+" + digits;

      // other countries
      return (hasPlus ? "+" : "") + digits;
    }

    function render(list){
      tbody.innerHTML = "";
      list.forEach(c => {
        const resume = c.resume_link ? `<a href="${esc(c.resume_link)}" target="_blank">View</a>` : "-";
        const email = c.email ? `<a href="mailto:${esc(c.email)}">${esc(c.email)}</a>` : "-";
        const created = c.created_at ? new Date(c.created_at).toLocaleDateString() : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="cell-name">${esc(c.name)}</td>
          <td class="cell-role">${esc(c.domain_role)}</td>
          <td class="cell-location">${esc(c.location)}</td>
          <td class="cell-email">${email}</td>
          <td class="cell-phone">${esc(c.phone)}</td>
          <td class="cell-resume">${resume}</td>
          <td class="cell-notes">${esc(c.notes)}</td>
          <td class="cell-created small">${esc(created)}</td>
          <td class="cell-actions"></td>
`;
        tbody.appendChild(tr);
      });
    }

    async function load(){
      errEl.textContent = "";
      try{
        const r = await apiGet("candidates");
        if(!r || r.ok === false) throw new Error(r?.error || "API failed");
        all = r.data || [];
        render(all);
      }catch(e){
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    }

    // ✅ Search
    document.getElementById("search").addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase().trim();
      const filtered = all.filter(c =>
        String(c.name||"").toLowerCase().includes(q) ||
        String(c.email||"").toLowerCase().includes(q) ||
        String(c.domain_role||"").toLowerCase().includes(q)
      );
      render(filtered);
    });

    // ✅ Add Candidate
    document.getElementById("btnAdd").addEventListener("click", async () => {
      statusEl.textContent = "Saving...";
      errEl.textContent = "";
      try{
        const payload = {
          name: document.getElementById("name").value.trim(),
          email: document.getElementById("email").value.trim(),
          phone: normalizePhone(document.getElementById("phone").value),
          location: document.getElementById("location").value.trim(),
          domain_role: document.getElementById("domain_role").value.trim(),
          resume_link: document.getElementById("resume_link").value.trim(),
          notes: document.getElementById("notes").value.trim()
        };

        if(!payload.name) throw new Error("Name is required");

        const r = await apiPost("addCandidate", payload);
        if(!r || r.ok === false) throw new Error(r?.error || "Save failed");

        ["name","email","phone","location","domain_role","resume_link","notes"].forEach(id => document.getElementById(id).value = "");
        statusEl.textContent = "Saved ✅";
        await load();
        setTimeout(()=>statusEl.textContent="", 1200);
      }catch(e){
        statusEl.textContent = "";
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    });

    // ✅ Delete Candidate
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button.danger");
      if(!btn) return;

      const id = btn.getAttribute("data-id");
      if(!id) return;

      if(!confirm("Delete this candidate?")) return;

      try{
        const r = await apiPost("deleteCandidate", { id });
        if(!r || r.ok === false) throw new Error(r?.error || "Delete failed");
        await load();
      }catch(err){
        alert("Error: " + err.message);
      }
    });

    load();
  </script>
</body>
</html>
