<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staffing Portal - Candidates</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Logo" />
      <span>Staffing Portal</span>
    </div>
    <div class="nav">
      <a href="index.html">Dashboard</a>
      <a class="active" href="candidates.html">Candidates</a>
      <a href="rtr.html">RTRs</a>
      <a href="recruiters.html">Recruiters</a>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h1>Candidates</h1>
      <p class="small">Add candidate + store resume as Google Drive link.</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <input id="name" placeholder="Name *" />
        <input id="email" placeholder="Email" />
        <input id="phone" placeholder="Phone (+1...)" />
        <input id="location" placeholder="Location" />
        <input id="domain_role" placeholder="Domain / Role (QA, Oracle, Java)" style="grid-column:1 / span 2;" />
        <input id="resume_link" placeholder="Resume Link (Google Drive)" style="grid-column:1 / span 2;" />
        <textarea id="notes" placeholder="Notes about candidate" style="grid-column:1 / span 2;min-height:70px;"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
        <button id="btnAdd">Add Candidate</button>
        <span class="small" id="status"></span>
      </div>
      <p class="small" id="err"></p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Candidate List</h2>
      <input id="search" placeholder="Search by name/email/role..." style="width:100%;margin-bottom:10px;" />

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">Name</th>
              <th style="width:140px;">Domain/Role</th>
              <th style="width:110px;">Location</th>
              <th style="width:170px;">Email</th>
              <th style="width:130px;">Phone</th>
              <th style="width:80px;">Resume</th>
              <th>Notes</th>
              <th style="width:110px;">Created</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const tbody = document.getElementById("tbody");
    let all = [];

    function esc(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function render(list){
      tbody.innerHTML = "";
      list.forEach(c => {
        const resume = c.resume_link ? `<a href="${esc(c.resume_link)}" target="_blank">View</a>` : "-";
        const email = c.email ? `<a class="email" href="mailto:${esc(c.email)}">${esc(c.email)}</a>` : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(c.name)}</td>
          <td class="nowrap">${esc(c.domain_role)}</td>
          <td class="nowrap">${esc(c.location)}</td>
          <td>${email}</td>
          <td class="phone">${esc(c.phone)}</td>
          <td>${resume}</td>
          <td class="notes">${esc(c.notes)}</td>
          <td class="nowrap">${c.created_at ? new Date(c.created_at).toLocaleDateString() : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function load(){
      errEl.textContent = "";
      try{
        const r = await apiGet("candidates");
        if(!r || r.ok === false) throw new Error(r?.error || "API failed");
        all = r.data || [];
        render(all);
      }catch(e){
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    }

    document.getElementById("search").addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase().trim();
      const filtered = all.filter(c =>
        String(c.name||"").toLowerCase().includes(q) ||
        String(c.email||"").toLowerCase().includes(q) ||
        String(c.domain_role||"").toLowerCase().includes(q)
      );
      render(filtered);
    });

    document.getElementById("btnAdd").addEventListener("click", async () => {
      statusEl.textContent = "Saving...";
      errEl.textContent = "";
      try{
        const payload = {
          name: document.getElementById("name").value.trim(),
          email: document.getElementById("email").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          location: document.getElementById("location").value.trim(),
          domain_role: document.getElementById("domain_role").value.trim(),
          resume_link: document.getElementById("resume_link").value.trim(),
          notes: document.getElementById("notes").value.trim()
        };

        if(!payload.name) throw new Error("Name is required");

        const r = await apiPost("addCandidate", payload);
        if(!r || r.ok === false) throw new Error(r?.error || "Save failed");

        ["name","email","phone","location","domain_role","resume_link","notes"].forEach(id => document.getElementById(id).value = "");
        statusEl.textContent = "Saved âœ…";
        await load();
        setTimeout(()=>statusEl.textContent="", 1200);
      }catch(e){
        statusEl.textContent = "";
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    });

    load();
  </script>
</body>
</html>
