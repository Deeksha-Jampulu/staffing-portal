<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simarn Staffing Portal - Candidates</title>
  <link rel="stylesheet" href="style.css?v=999" />
</head>
<body>

  <nav class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Simarn Logo" />
      <span>Simarn Staffing Portal</span>
    </div>
    <div class="nav-links">
      <a href="index.html">Dashboard</a>
      <a class="active" href="candidates.html">Candidates</a>
      <a href="rtrs.html">RTRs</a>
      <a href="recruiters.html">Recruiters</a>
    </div>
  </nav>

  <div class="container">

    <!-- ADD CANDIDATE -->
    <div class="card">
      <h1>Candidates</h1>
      <p class="small">Add candidate and store resume as Google Drive link.</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <input id="name" placeholder="Name *" />
        <input id="email" placeholder="Email" />
        <input id="phone" placeholder="Phone (ex: +1 469 123 4567)" />
        <input id="location" placeholder="Location" />
        <input id="domain_role" placeholder="Domain / Role (QA, Oracle, Java)" style="grid-column:1 / span 2;" />
        <input id="resume_link" placeholder="Resume Link (Google Drive)" style="grid-column:1 / span 2;" />
        <textarea id="notes" placeholder="Notes about candidate" style="grid-column:1 / span 2;"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
        <button id="btnAdd">Add Candidate</button>
        <span class="small" id="status"></span>
      </div>
    </div>

    <!-- LIST -->
    <div class="card">
      <h2 style="margin:0 0 10px;">Candidate List</h2>
      <input id="search" placeholder="Search by name/email/role..." style="width:100%;margin-bottom:10px;" />

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:180px;">Name</th>
              <th style="min-width:160px;">Domain/Role</th>
              <th style="min-width:120px;">Location</th>
              <th style="min-width:220px;">Email</th>
              <th style="min-width:150px;">Phone</th>
              <th style="min-width:90px;">Resume</th>
              <th style="min-width:340px;">Notes</th>
              <th style="min-width:110px;">Created</th>
              <th style="min-width:110px;">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="small" id="err" style="margin-top:10px;"></p>
    </div>

  </div>

  <script src="app.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const tbody = document.getElementById("tbody");
    let all = [];

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    // ✅ Fix wrapping for email + notes using inline styles (works even if CSS is weird)
    function render(list){
      tbody.innerHTML = "";

      list.forEach(c => {
        const resume = c.resume_link ? `<a href="${esc(c.resume_link)}" target="_blank">View</a>` : "-";
        const email = c.email
          ? `<a href="mailto:${esc(c.email)}" style="display:inline-block;max-width:220px;white-space:normal;overflow-wrap:anywhere;word-break:normal;">${esc(c.email)}</a>`
          : "-";

        const created = c.created_at ? new Date(c.created_at).toLocaleDateString() : "";
        const cid = c.candidate_id || "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="white-space:nowrap;">${esc(c.name)}</td>
          <td style="white-space:nowrap;">${esc(c.domain_role)}</td>
          <td style="white-space:nowrap;">${esc(c.location)}</td>

          <td>${email}</td>

          <td style="white-space:nowrap;">${esc(c.phone)}</td>
          <td style="white-space:nowrap;">${resume}</td>

          <td style="max-width:340px;white-space:normal;overflow-wrap:break-word;word-break:normal;">
            ${esc(c.notes)}
          </td>

          <td style="white-space:nowrap;" class="small">${esc(created)}</td>

          <td style="white-space:nowrap;">
            <button class="danger btnDel" data-id="${esc(cid)}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // attach delete clicks
      document.querySelectorAll(".btnDel").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if(!id){
            alert("Missing candidate_id. Delete needs candidate_id from sheet.");
            return;
          }
          if(!confirm("Delete this candidate?")) return;

          try{
            const r = await apiPost("deleteCandidate", { candidate_id: id });
            if(!r || r.ok === false) throw new Error(r?.error || "Delete failed");
            await load();
          }catch(e){
            alert("Error: " + e.message);
          }
        });
      });
    }

    async function load(){
      errEl.textContent = "";
      try{
        const r = await apiGet("candidates");
        if(!r || r.ok === false) throw new Error(r?.error || "API failed");
        all = r.data || [];
        render(all);
      }catch(e){
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    }

    document.getElementById("search").addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase().trim();
      const filtered = all.filter(c =>
        String(c.name||"").toLowerCase().includes(q) ||
        String(c.email||"").toLowerCase().includes(q) ||
        String(c.domain_role||"").toLowerCase().includes(q)
      );
      render(filtered);
    });

    document.getElementById("btnAdd").addEventListener("click", async () => {
      statusEl.textContent = "Saving...";
      errEl.textContent = "";

      try{
        // ✅ phone accepts anything; we store exactly what user typed (spaces/+ are okay)
        const payload = {
          name: document.getElementById("name").value.trim(),
          email: document.getElementById("email").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          location: document.getElementById("location").value.trim(),
          domain_role: document.getElementById("domain_role").value.trim(),
          resume_link: document.getElementById("resume_link").value.trim(),
          notes: document.getElementById("notes").value.trim()
        };

        if(!payload.name) throw new Error("Name is required");

        const r = await apiPost("addCandidate", payload);
        if(!r || r.ok === false) throw new Error(r?.error || "Save failed");

        ["name","email","phone","location","domain_role","resume_link","notes"]
          .forEach(id => document.getElementById(id).value = "");

        statusEl.textContent = "Saved ✅";
        await load();
        setTimeout(()=>statusEl.textContent="", 1200);
      }catch(e){
        statusEl.textContent = "";
        errEl.textContent = "Error: " + e.message;
        console.error(e);
      }
    });

    load();
  </script>
</body>
</html>
